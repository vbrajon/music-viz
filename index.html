<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">

<style>body { background: black;margin: 0; }</style>
<canvas></canvas>

<!--<style>iframe { position: absolute;top: 0;left: 0;width: 30%;height: 45%; }</style>
<iframe src="//player.vimeo.com/video/77179682#t=9s?autoplay=1&loop=1" frameborder="0"></iframe>-->

<script src="https://cdn.rawgit.com/andrewplummer/Sugar/2.0.2/dist/sugar.js"></script>
<script>Sugar.Array.defineInstance({ chunk: (arr, size) => Array(Math.ceil(arr.length / size)).fill().map((_, i) => arr.slice(i * size, i * size + size)) })</script>
<script>Sugar.extend({ objectPrototype: true })</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.5/dat.gui.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/pizzicato/0.6.1/Pizzicato.min.js"></script>
<script>
window.canvas = window.document.querySelector('canvas')
window.ctx = canvas.getContext('2d')
window.gui = new dat.GUI()
window.intensity = 1
window.level_num = 16
window.volume = 1
window.db = 0
gui.add(window, 'intensity', 0, 2).step(.1).name('Intensity')
gui.add(window, 'level_num', 0, 64).step(2).name('Level Count')
gui.add(window, 'db')
window.sound = new Pz.Sound({ source: 'input', options: { detached: true } }, () => {
  window.analyser = Pz.context.createAnalyser()
  // window.gainNode = analyser.context.createGain()
  // gainNode.connect(analyser.context.destination)

  analyser.fftSize = 1024
  window.frequency = new Uint8Array(analyser.frequencyBinCount)
  window.timedomain = new Uint8Array(analyser.frequencyBinCount)
  const loop = () => {
    analyser.getByteFrequencyData(frequency)
    analyser.getByteTimeDomainData(timedomain)
    // levels = frequency.chunk(frequency.length % 16)
    // db = 20 * Math.log10(gainNode.gain.value)

    canvas.width = window.innerWidth
    canvas.height = window.innerHeight
    ctx.fillStyle = 'black'
    ctx.fillRect(0, 0, canvas.width, canvas.height)
    ctx.fillStyle = 'white'
    ctx.strokeStyle = 'white'
    // bar(canvas, ctx, frequency, timedomain)
    // line(canvas, ctx, frequency, timedomain)
    bass(canvas, ctx, frequency, timedomain)
    circle(canvas, ctx, frequency, timedomain)
    window.requestAnimationFrame(loop)
  }
  sound.connect(analyser)
  sound.play()
  loop()
})

function bass(canvas, ctx, frequency, timedomain) {
  x = canvas.width / 2
  y = canvas.height / 2
  ctx.lineWidth = canvas.width / level_num / 3
  Array.from(frequency)
  .chunk(frequency.length / level_num)
  .map('sum')
  .map(s => s * intensity / level_num / 256)
  .map((d, i) => {
    if (i > 4 || d < .5 || volume < .5) return
    ctx.beginPath()
    ctx.arc(x, y, i * ctx.lineWidth * 1.4, 0, Math.PI * 2)
    ctx.stroke()
  })
}

function circle(canvas, ctx, frequency, timedomain) {
  x = canvas.width / 2
  y = canvas.height / 2
  ctx.lineWidth = canvas.width / level_num / 3
  Array.from(frequency)
  .chunk(frequency.length / level_num)
  .map('sum')
  .map(s => s * intensity / level_num / 256)
  .map((d, i) => {
    if (i < 4) return
    ctx.beginPath()
    ctx.arc(x, y, i * ctx.lineWidth * 1.4, 0, Math.PI * 2 * d)
    ctx.stroke()
  })
}

function bar(canvas, ctx, frequency, timedomain) {
  const sliceWidth = canvas.width / analyser.frequencyBinCount * 10
  frequency.map((d, i) => {
    if (i % 10) return
    ctx.fillRect(i * (sliceWidth + 1), canvas.height - d * 2.5, sliceWidth, d * 2.5)
  })
}

function line(canvas, ctx, frequency, timedomain) {
  ctx.lineWidth = 4
  ctx.beginPath()

  var sliceWidth = canvas.width / analyser.frequencyBinCount * 24
  var x = 0
  var previousX
  var previousY
  for (var i = 0; i < analyser.frequencyBinCount; i++) {
    if (i % 24) continue

    var v = timedomain[i] / 128.0
    var y = v * canvas.height / 4.2

    if (i === 0) {
      ctx.moveTo(x, y)
    } else {
      var xc = (previousX + x) / 2
      var yc = (previousY + y) / 2

      ctx.quadraticCurveTo(previousX, previousY, xc, yc)
    }

    previousX = x
    previousY = y
    x += sliceWidth
  }
  ctx.lineTo(previousX + sliceWidth, previousY)
  ctx.stroke()
}
</script>
